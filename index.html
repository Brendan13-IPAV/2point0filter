<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IP Strategy Finder</title>

  <!-- External CSS -->
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="header-content">
        <div class="logo">IP Strategy Finder</div>
        <nav class="nav">
          <a href="#">Home</a>
          <a href="#">About</a>
        </nav>
      </div>
    </div>
  </header>

  <div class="container main-content">
    <div id="app">Loading...</div>
  </div>

  <footer class="footer">
    <div class="container">
      <p style="text-align: center; font-size: 14px;">&copy; 2025 IP Strategy Finder</p>
    </div>
  </footer>

  <script>
    Promise.all([
      fetch('strategies.json').then(res => res.json()),
      fetch('preferences.json').then(res => res.json())
    ]).then(([strategiesData, preferenceConfigs]) => {

      const ipRightsOptions = [
        { id: 'Patent', label: 'Patents', color: 'patent' },
        { id: 'Trade mark', label: 'Trade marks', color: 'trademark' },
        { id: 'Design', label: 'Design rights', color: 'design' },
        { id: 'PBR', label: 'Plant breeder\'s rights', color: 'pbr' },
        { id: 'Copyright', label: 'Copyright', color: 'copyright' },
        { id: 'Any', label: 'Any IP right', color: 'any' }
      ];

      const situationOptions = [
        { id: 'Accused', label: 'I\'ve been accused of infringing' },
        { id: 'Enforcement', label: 'I believe my IP has been infringed' },
        { id: 'Proactive', label: 'I\'m proactively protecting my IP' },
        { id: 'Professional', label: 'I\'m seeking support of an IP professional' }
      ];

      function IPStrategyFinder() {
        const savedState = JSON.parse(localStorage.getItem('ipStrategyState')) || {};
        const state = {
          loading: true,
          strategies: strategiesData,
          filteredStrategies: [],
          accordions: savedState.accordions || { preferences: true, otherFactors: true },
          selectedRights: savedState.selectedRights || ['Trade mark'],
          selectedSituations: savedState.selectedSituations || ['Enforcement'],
          preferences: savedState.preferences || {
            timeCommitment: 0,
            investment: 0,
            commercialAgreements: 0,
            thirdPartyServices: 0,
            legalAction: 0
          },
          otherFactors: savedState.otherFactors || {
            onlineMarkets: 'neutral',
            domainName: 'neutral',
            importingGoods: 'neutral',
            identifyParty: 'neutral'
          }
        };

        function init() {
          state.loading = false;
          filterAndRankStrategies();
          render();
        }

        function filterAndRankStrategies() {
          let filtered = state.strategies.slice();

          if (state.selectedRights.length > 0) {
            filtered = filtered.filter(strategy => {
              const strategyRights = strategy.right.split('; ');
              return state.selectedRights.some(right =>
                strategyRights.includes(right) ||
                strategyRights.includes('Any') ||
                strategyRights.includes('Any IP right')
              );
            });
          }

          if (state.selectedSituations.length > 0) {
            filtered = filtered.filter(strategy =>
              state.selectedSituations.some(situation =>
                strategy.responseType.includes(situation)
              )
            );
          }

          state.filteredStrategies = filtered.map(strategy => {
            let totalScore = 0;
            let totalWeight = 0;

            function calculateMatch(prefKey, userValue, strategyValue) {
              if (userValue === 0) return { score: 0, weight: 0 };
              const config = preferenceConfigs[prefKey];
              const max = Math.max(...config.options.map(opt => Math.abs(opt.value)));
              const weight = Math.abs(userValue) / max;
              const expected = (userValue > 0 ? userValue / max * 10 : 0);
              const score = userValue > 0 ? Math.max(0, 10 - Math.abs(expected - strategyValue)) : Math.max(0, 10 - strategyValue);
              return { score, weight };
            }

            ['timeCommitment', 'investment', 'commercialAgreements', 'thirdPartyServices', 'legalAction'].forEach(key => {
              const { score, weight } = calculateMatch(key, state.preferences[key], strategy.scores[key]);
              totalScore += score * weight;
              totalWeight += weight;
            });

            const matchScore = totalWeight > 0 ? (totalScore / (totalWeight * 10)) * 100 : 100;
            return { ...strategy, matchScore };
          }).sort((a, b) => b.matchScore - a.matchScore);
        }

        function render() {
          localStorage.setItem('ipStrategyState', JSON.stringify({
            accordions: state.accordions,
            selectedRights: state.selectedRights,
            selectedSituations: state.selectedSituations,
            preferences: state.preferences,
            otherFactors: state.otherFactors
          }));
          function renderActiveFilters() {
            const filterContainer = document.createElement('div');
            filterContainer.className = 'active-filters';

            state.selectedRights.forEach(right => {
              const pill = document.createElement('div');
              pill.className = 'filter-pill';
              pill.textContent = right;
              const remove = document.createElement('span');
              remove.className = 'filter-remove';
              remove.textContent = '×';
              remove.onclick = () => {
                state.selectedRights = state.selectedRights.filter(r => r !== right);
                filterAndRankStrategies();
                render();
              };
              pill.appendChild(remove);
              filterContainer.appendChild(pill);
            });

            state.selectedSituations.forEach(situation => {
              const pill = document.createElement('div');
              pill.className = 'filter-pill situation';
              pill.textContent = situation;
              const remove = document.createElement('span');
              remove.className = 'filter-remove';
              remove.textContent = '×';
              remove.onclick = () => {
                state.selectedSituations = state.selectedSituations.filter(s => s !== situation);
                filterAndRankStrategies();
                render();
              };
              pill.appendChild(remove);
              filterContainer.appendChild(pill);
            });

            Object.entries(state.preferences).forEach(([key, value]) => {
              if (value !== 0) {
                const config = preferenceConfigs[key];
                const opt = config.options.find(o => o.value === value);
                const pill = document.createElement('div');
                pill.className = 'filter-pill';
                pill.textContent = `${config.label}: ${opt.label}`;
                const remove = document.createElement('span');
                remove.className = 'filter-remove';
                remove.textContent = '×';
                remove.onclick = () => {
                  state.preferences[key] = 0;
                  filterAndRankStrategies();
                  render();
                };
                pill.appendChild(remove);
                filterContainer.appendChild(pill);
              }
            });

            Object.entries(state.otherFactors).forEach(([key, value]) => {
              if (value !== 'neutral') {
                const labelMap = {
                  onlineMarkets: 'Online marketplaces',
                  domainName: 'Domain name issues',
                  importingGoods: 'Importing goods',
                  identifyParty: 'Identify party'
                };
                const pill = document.createElement('div');
                pill.className = 'filter-pill';
                pill.textContent = `${labelMap[key]}: ${value}`;
                const remove = document.createElement('span');
                remove.className = 'filter-remove';
                remove.textContent = '×';
                remove.onclick = () => {
                  state.otherFactors[key] = 'neutral';
                  filterAndRankStrategies();
                  render();
                };
                pill.appendChild(remove);
                filterContainer.appendChild(pill);
              }
            });

            return filterContainer;
          }
          const app = document.getElementById('app');
          app.innerHTML = '';

          const container = document.createElement('div');
          container.className = 'grid';

          const leftCol = document.createElement('div');
          leftCol.appendChild(renderPreferencesAccordion());
          leftCol.appendChild(renderOtherFactorsAccordion());
          container.appendChild(leftCol);

          const rightCol = document.createElement('div');
          rightCol.appendChild(renderActiveFilters());
          rightCol.appendChild(renderStrategyCards());
          container.appendChild(rightCol);

          app.appendChild(container);
        }

        function renderPreferencesAccordion() {
          const wrapper = document.createElement('div');

          const toggle = document.createElement('div');
          toggle.className = 'accordion-header';
          toggle.style.cursor = 'pointer';
          toggle.style.transition = 'all 0.3s ease';
          toggle.innerHTML = '<span class="accordion-arrow" style="display:inline-block; transition: transform 0.3s ease; transform: ' + (state.accordions.preferences ? 'rotate(90deg)' : 'rotate(0deg)') + ';">▶</span> Preferences';
          toggle.onclick = () => {
            state.accordions.preferences = !state.accordions.preferences;
            render();
          };
          wrapper.appendChild(toggle);

          if (!state.accordions.preferences) return wrapper;

          const accordion = document.createElement('div');
          accordion.className = 'accordion';

          Object.entries(preferenceConfigs).forEach(([key, config]) => {
            const group = document.createElement('div');
            group.className = 'preference-group';

            const label = document.createElement('label');
            label.className = 'preference-label';
            label.textContent = config.label;
            group.appendChild(label);

            const radioGroup = document.createElement('div');
            radioGroup.className = 'radio-group';
            config.options.forEach(opt => {
              const radio = document.createElement('label');
              radio.className = 'radio-button';
              if (state.preferences[key] === opt.value) {
                radio.classList.add('radio-selected');
              }
              radio.textContent = opt.label;
              radio.onclick = () => {
                state.preferences[key] = state.preferences[key] === opt.value ? 0 : opt.value;
                filterAndRankStrategies();
                render();
              };
              radioGroup.appendChild(radio);
            });
            group.appendChild(radioGroup);
            accordion.appendChild(group);
          });

          wrapper.appendChild(accordion);
          return wrapper;
        }

        function renderOtherFactorsAccordion() {
          const wrapper = document.createElement('div');

          const toggle = document.createElement('div');
          toggle.className = 'accordion-header';
          toggle.innerHTML = '<span class="accordion-arrow" style="display:inline-block; transition: transform 0.3s ease; transform: ' + (state.accordions.otherFactors ? 'rotate(90deg)' : 'rotate(0deg)') + ';">▶</span> Other Factors';
          toggle.onclick = () => {
            state.accordions.otherFactors = !state.accordions.otherFactors;
            render();
          };
          wrapper.appendChild(toggle);

          if (!state.accordions.otherFactors) return wrapper;

          const factors = [
            { key: 'onlineMarkets', label: 'Online marketplaces' },
            { key: 'domainName', label: 'Domain name issues' },
            { key: 'importingGoods', label: 'Importing goods' },
            { key: 'identifyParty', label: 'Identify party' }
          ];

          factors.forEach(({ key, label }) => {
            const group = document.createElement('div');
            group.className = 'preference-group';

            const groupLabel = document.createElement('label');
            groupLabel.className = 'preference-label';
            groupLabel.textContent = label;
            group.appendChild(groupLabel);

            const radioGroup = document.createElement('div');
            radioGroup.className = 'radio-group';

            ['yes', 'no', 'unsure'].forEach(option => {
              const radio = document.createElement('label');
              radio.className = 'radio-button';
              if (state.otherFactors[key] === option) {
                radio.classList.add('radio-selected');
              }
              radio.textContent = option.charAt(0).toUpperCase() + option.slice(1);
              radio.onclick = () => {
                state.otherFactors[key] = state.otherFactors[key] === option ? 'neutral' : option;
                filterAndRankStrategies();
                render();
              };
              radioGroup.appendChild(radio);
            });

            group.appendChild(radioGroup);
            wrapper.appendChild(group);
          });

          return wrapper;
        }

   function getTagValue(prefKey, scoreValue) {
  const config = preferenceConfigs[prefKey];
  if (!config) return '';
  const closest = config.options.reduce((prev, curr) =>
    Math.abs(curr.value * 5 - scoreValue) < Math.abs(prev.value * 5 - scoreValue) ? curr : prev
  );
  return closest.label;
}

function renderStrategyCards() {
  const list = document.createElement('div');
  list.className = 'card-grid';

  const activePrefs = Object.values(state.preferences).filter(v => v !== 0).length;
  const activeFactors = Object.values(state.otherFactors).filter(v => v !== 'neutral').length;
  const showUnknown = (activePrefs + activeFactors) < 2;

  state.filteredStrategies.forEach((strategy, index) => {
    const card = document.createElement('div');
    card.className = 'strategy-card';
    card.style.opacity = '0';
    card.style.transition = 'transform 0.6s ease, opacity 0.6s ease';
    setTimeout(() => { card.style.opacity = '1'; }, 50);

    const mainRight = strategy.right.split('; ')[0];
    const borderClass = `border-${mainRight.toLowerCase().replace(/\s/g, '')}`;
    card.classList.add(borderClass);

    let matchLabel = 'Unknown';
    let relevanceClass = 'unknown';
    const score = strategy.matchScore;
    if (!showUnknown) {
      if (score >= 90) { matchLabel = 'Very High'; relevanceClass = 'very-high'; }
      else if (score >= 75) { matchLabel = 'High'; relevanceClass = 'high'; }
      else if (score >= 50) { matchLabel = 'Medium'; relevanceClass = 'medium'; }
      else if (score >= 25) { matchLabel = 'Low'; relevanceClass = 'low'; }
      else { matchLabel = 'Very Low'; relevanceClass = 'very-low'; }
    }

    card.innerHTML = `
      <div class="relevancy">
        <span class="relevancy-label">Likely Applicability:</span>
        <span class="relevancy-badge ${relevanceClass}">${matchLabel}</span>
      </div>
      <div class="strategy-overtitle">${strategy.overtitle}</div>
      <h3 class="strategy-title">${strategy.title}</h3>
      <p class="strategy-description">${strategy.description}</p>
      <div class="strategy-metadata">
        <div class="metadata-row">
          <span>Time Commitment:</span>
          <span class="tag">${getTagValue('timeCommitment', strategy.scores.timeCommitment)}</span>
        </div>
        <div class="metadata-row">
          <span>Investment:</span>
          <span class="tag">${getTagValue('investment', strategy.scores.investment)}</span>
        </div>
        <div class="metadata-row">
          <span>IP Type:</span>
          <span class="tag">${strategy.right}</span>
        </div>
      </div>
    `;
    list.appendChild(card);
  });

  return list;
}



        return { init };
      }

      const app = IPStrategyFinder();
      app.init();

      // Add reset filters button
      const resetBtn = document.createElement('button');
      resetBtn.textContent = 'Clear All Filters';
      resetBtn.style.margin = '20px 0';
      resetBtn.className = 'reset-button';
      resetBtn.onclick = () => {
        localStorage.removeItem('ipStrategyState');
        location.reload();
      };
      document.getElementById('app').prepend(resetBtn);
    }).catch(err => {
      console.error('Error loading data:', err);
      document.getElementById('app').textContent = 'Failed to load data.';
    });
  </script>
</body>
</html>
