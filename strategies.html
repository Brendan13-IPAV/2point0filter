<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IP First Response 2.0</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="header-content">
        <div class="logo">IP First Response 2.0</div>
        <nav class="nav">
          <a href="index.html">Home</a>
          <a href="#">About</a>
        </nav>
      </div>
    </div>
  </header>

  <div class="container main-content">
    <div id="app">Loading... Please wait while we prepare your options</div>
  </div>

  <footer class="footer">
    <div class="container">
      <p style="text-align: center; font-size: 14px;">&copy; 2025 IP Strategy Finder</p>
    </div>
  </footer>

  <script type="module">
    import { calculateStrategyScores } from './scoring.js';

    const [strategiesData, preferenceConfigs, scoringMatrix] = await Promise.all([
      fetch('strategies.json').then(res => res.json()),
      fetch('preferences.json').then(res => res.json()),
      fetch('scoring-matrix.json').then(res => res.json())
    ]);

    function IPStrategyFinder() {
      const savedState = JSON.parse(localStorage.getItem('ipStrategyState')) || {};
      const allRights = ['Patent', 'Trade mark', 'Design', 'PBR', 'Copyright', 'Any'];

      const state = {
        loading: true,
        strategies: strategiesData,
        filteredStrategies: [],
        accordions: savedState.accordions || {
          preferences: true,
          otherFactors: true,
          situationFilters: true,
          ipTypeFilters: true
        },
        selectedRights: savedState.selectedRights || allRights,
        selectedSituations: savedState.selectedSituations || ['Enforcement'],
        preferences: {
          timeCommitment: 0,
          investment: 0,
          commercialAgreements: 0,
          thirdPartyServices: 0,
          legalAction: 0
        },
        otherFactors: {
          onlineMarkets: 'neutral',
          domainName: 'neutral',
          importingGoods: 'neutral',
          identifyParty: 'neutral'
        },
        situationSpecificFilters: {},
        ipTypeSpecificFilters: {}
      };

      function filterAndRankStrategies() {
        let filtered = state.strategies;

        if (state.selectedRights.length > 0) {
          filtered = filtered.filter(strategy => {
            const strategyRights = strategy.right.split('; ');
            return state.selectedRights.some(right =>
              strategyRights.includes(right) ||
              strategyRights.includes('Any') ||
              strategyRights.includes('Any IP right')
            );
          });
        }

        if (state.selectedSituations.length > 0) {
          filtered = filtered.filter(strategy =>
            state.selectedSituations.some(situation =>
              strategy.responseType.includes(situation)
            )
          );
        }

        state.filteredStrategies = calculateStrategyScores(filtered, state, scoringMatrix);
      }

      function init() {
        state.loading = false;
        filterAndRankStrategies();
        render();
      }

      function render() {
        const app = document.getElementById('app');
        app.innerHTML = '';

        state.filteredStrategies.forEach((strategy, index) => {
          const card = document.createElement('div');
          card.className = 'strategy-card';
          if (!strategy.isApplicable) card.classList.add('not-applicable');

          let matchLabel = 'Possible';
          const score = strategy.matchScore;

          if (!strategy.isApplicable) {
            matchLabel = 'Not Applicable';
          } else {
            if (score >= 90) matchLabel = 'Highly Likely';
            else if (score >= 75) matchLabel = 'Likely';
            else if (score >= 50) matchLabel = 'Possible';
            else if (score >= 25) matchLabel = 'Unlikely';
            else matchLabel = 'Probably Not-Applicable';
          }

          card.innerHTML = `
            <div class="relevancy">
              <span class="relevancy-label">Applicability:</span>
              <span class="relevancy-badge">${matchLabel}</span>
            </div>
            <div class="strategy-overtitle">${strategy.overtitle || ''}</div>
            <h3 class="strategy-title">${strategy.title}</h3>
            <p class="strategy-description">${strategy.description || ''}</p>
            <div class="card-metrics">
              <div class="metric-row">
                <span class="metric-label">Estimated cost:</span>
                <span class="metric-value">${strategy.costText || 'Cost varies based on complexity'}</span>
              </div>
              <div class="metric-row">
                <span class="metric-label">Estimated effort:</span>
                <span class="metric-value">${strategy.effortText || 'Time requirement varies'}</span>
              </div>
              <div class="metric-row">
                <span class="metric-label">Rate of resolution:</span>
                <span class="metric-value">${strategy.resolutionText || 'Success rate varies by case'}</span>
              </div>
            </div>
          `;

          app.appendChild(card);
        });
      }

      return { init };
    }

    const app = IPStrategyFinder();
    app.init();
  </script>
</body>
</html>
