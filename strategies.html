<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IP First Response 2.0</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="app">Loading...</div>

  <script type="module">
    import { calculateStrategyScores } from './scoring.js';

    const [strategiesData, preferenceConfigs, scoringMatrix] = await Promise.all([
      fetch('strategies.json').then(res => res.json()),
      fetch('preferences.json').then(res => res.json()),
      fetch('scoring-matrix.json').then(res => res.json())
    ]);

    function IPStrategyFinder() {
      const savedState = JSON.parse(localStorage.getItem('ipStrategyState')) || {};
      const allRights = ['Patent', 'Trade mark', 'Design', 'PBR', 'Copyright', 'Any'];

      const state = {
        loading: true,
        strategies: strategiesData,
        filteredStrategies: [],
        accordions: savedState.accordions || { 
          preferences: true, 
          otherFactors: true, 
          situationFilters: true, 
          ipTypeFilters: true 
        },
        selectedRights: savedState.selectedRights || allRights,
        selectedSituations: savedState.selectedSituations || ['Enforcement'],
        preferences: {
          timeCommitment: 0,
          investment: 0,
          commercialAgreements: 0,
          thirdPartyServices: 0,
          legalAction: 0
        },
        otherFactors: {
          onlineMarkets: 'neutral',
          domainName: 'neutral',
          importingGoods: 'neutral',
          identifyParty: 'neutral'
        },
        situationSpecificFilters: {},
        ipTypeSpecificFilters: {}
      };

      function filterAndRankStrategies() {
        let filtered = state.strategies;

        if (state.selectedRights.length > 0) {
          filtered = filtered.filter(strategy => {
            const strategyRights = strategy.right.split('; ');
            return state.selectedRights.some(right =>
              strategyRights.includes(right) ||
              strategyRights.includes('Any') ||
              strategyRights.includes('Any IP right')
            );
          });
        }

        if (state.selectedSituations.length > 0) {
          filtered = filtered.filter(strategy =>
            state.selectedSituations.some(situation =>
              strategy.responseType.includes(situation)
            )
          );
        }

        state.filteredStrategies = calculateStrategyScores(filtered, state, scoringMatrix);
      }

      function init() {
        state.loading = false;
        filterAndRankStrategies();
        render();
      }

      function render() {
        const app = document.getElementById('app');
        app.innerHTML = '';

        const ul = document.createElement('ul');
        state.filteredStrategies.forEach(strategy => {
          const li = document.createElement('li');
          li.textContent = `${strategy.title} — Score: ${strategy.matchScore} — ${strategy.isApplicable ? 'Applicable' : 'Not Applicable'}`;
          ul.appendChild(li);
        });

        app.appendChild(ul);
      }

      return { init };
    }

    const app = IPStrategyFinder();
    app.init();
  </script>
</body>
</html>
