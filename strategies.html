<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IP First Response 2.0</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .strategy-card { border: 1px solid #ccc; padding: 12px; margin-bottom: 10px; border-radius: 6px; transition: 0.3s; }
    .strategy-card h3 { margin-top: 0; }
    .badge { display: inline-block; padding: 2px 6px; font-size: 12px; border-radius: 4px; background-color: #eee; margin-left: 8px; }
    .score-high { background-color: #d4edda; color: #155724; }
    .score-low { background-color: #f8d7da; color: #721c24; }
    .not-applicable { opacity: 0.6; font-style: italic; }
  </style>
</head>
<body>
  <div class="container">
    <h1>IP Strategy Options</h1>
    <div id="app">Loading strategies...</div>
  </div>

  <script type="module">
    import { calculateStrategyScores } from './scoring.js';

    const [strategiesData, preferenceConfigs, scoringMatrix] = await Promise.all([
      fetch('strategies.json').then(res => res.json()),
      fetch('preferences.json').then(res => res.json()),
      fetch('scoring-matrix.json').then(res => res.json())
    ]);

    function IPStrategyFinder() {
      const savedState = JSON.parse(localStorage.getItem('ipStrategyState')) || {};
      const allRights = ['Patent', 'Trade mark', 'Design', 'PBR', 'Copyright', 'Any'];

      const state = {
        loading: true,
        strategies: strategiesData,
        filteredStrategies: [],
        selectedRights: savedState.selectedRights || allRights,
        selectedSituations: savedState.selectedSituations || ['Enforcement'],
        preferences: {
          timeCommitment: 0,
          investment: 0,
          commercialAgreements: 0,
          thirdPartyServices: 0,
          legalAction: 0
        },
        otherFactors: {
          onlineMarkets: 'neutral',
          domainName: 'neutral',
          importingGoods: 'neutral',
          identifyParty: 'neutral'
        },
        situationSpecificFilters: {},
        ipTypeSpecificFilters: {}
      };

      function filterAndRankStrategies() {
        let filtered = state.strategies;

        if (state.selectedRights.length > 0) {
          filtered = filtered.filter(strategy => {
            const strategyRights = strategy.right.split('; ');
            return state.selectedRights.some(right =>
              strategyRights.includes(right) ||
              strategyRights.includes('Any') ||
              strategyRights.includes('Any IP right')
            );
          });
        }

        if (state.selectedSituations.length > 0) {
          filtered = filtered.filter(strategy =>
            state.selectedSituations.some(situation =>
              strategy.responseType.includes(situation)
            )
          );
        }

        state.filteredStrategies = calculateStrategyScores(filtered, state, scoringMatrix);
      }

      function init() {
        state.loading = false;
        filterAndRankStrategies();
        render();
      }

      function render() {
        const app = document.getElementById('app');
        app.innerHTML = '';

        if (state.filteredStrategies.length === 0) {
          app.textContent = 'No strategies found.';
          return;
        }

        state.filteredStrategies.forEach(strategy => {
          const card = document.createElement('div');
          card.className = 'strategy-card';
          if (!strategy.isApplicable) card.classList.add('not-applicable');

          const title = document.createElement('h3');
          title.textContent = strategy.title;

          const desc = document.createElement('p');
          desc.textContent = strategy.description || '(No description provided)';

          const score = document.createElement('div');
          const badge = document.createElement('span');
          badge.className = 'badge ' + (strategy.matchScore >= 75 ? 'score-high' : 'score-low');
          badge.textContent = strategy.isApplicable ? `Score: ${strategy.matchScore}` : 'Not Applicable';
          score.appendChild(badge);

          card.appendChild(title);
          card.appendChild(desc);
          card.appendChild(score);

          app.appendChild(card);
        });
      }

      return { init };
    }

    const app = IPStrategyFinder();
    app.init();
  </script>
</body>
</html>
